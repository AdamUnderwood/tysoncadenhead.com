<!DOCTYPE html>
<!--[if IE 6]>
    <html id="ie6" lang="en-US">
<![endif]-->
<!--[if IE 7]>
    <html id="ie7" lang="en-US">
<![endif]-->
<!--[if IE 8]>
    <html id="ie8" lang="en-US">
<![endif]-->
<!--[if !(IE 6) | !(IE 7) | !(IE 8)  ]><!-->
    <html lang="en-US">
<!--<![endif]-->
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width; initial-scale=1.0; maximum-scale=1.0;">
        <meta name="google-site-verification" content="AeV4w7EOhEv3lU1OT8KOM7jRS0C6jDAsZyMaG38t1g4" />
        <meta property="og:image" content="http://www.tysoncadenhead.com/images/blog/using-facebook-authentication-on-a-sails-js-app.jpg"/>
        <meta property="og:title" content="Facebook Authentication With Sails.js and Passport"/>
        <meta property="og:url" content="http://www.tysoncadenhead.com"/>
        <meta property="og:site_name" content="Tyson Cadenhead"/>
        <meta property="og:description" content="Thoughts on productivity, web apps and JavaScript" />
        <title>Facebook Authentication With Sails.js and Passport</title>
        <link rel="shortcut icon" href="/images/favicon.ico" /> 
        <link rel="stylesheet" href="/css/app.css" />
        <link rel="alternate" type="application/rss+xml" title="Facebook Authentication With Sails.js and Passport Thoughts on productivity, web apps and JavaScript" href="http://www.tysoncadenhead.com/feed.xml" />
        
    </head>
    <body>
        <script type="text/javascript">

          var _gaq = _gaq || [];
          _gaq.push(['_setAccount', 'UA-19696495-1']);
          _gaq.push(['_trackPageview']);
        
          (function() {
            var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
            ga.src = ('https:' == document.location.protocol ? 'https://' : 'http://') + 'stats.g.doubleclick.net/dc.js';
            var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
          })();
        
        </script>
        <div id="fb-root"></div>
        <div class="header" id="top">
            <div class="container">
                <div class="span12">
                    <div class="span4 left">
                        <h1 id="logo"><a href="/"><img src="/images/logo.png" /></a></h1>
                    </div>
                    <div class="span6 right">
                        <div class="navbar navbar-inverse">
                            <div class="navbar-inner right">
                                <ul class="nav right">
                                  <li><a href="/">Blog</a></li>
                                  <li><a href="/presentations">Presentations</a></li>
                                  <li><a href="/about">About Me</a></li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="container">
            <div class="span12">
                
                    
                    
                        
                        <article>

    <div class="well span2 right thumbnail">
      <img src="/images/blog/using-facebook-authentication-on-a-sails-js-app.jpg" />
    </div>

    <h1>Facebook Authentication With Sails.js and Passport</h1>

    

    <h5><span class="label label-info"><a href="/?category=code">code</a></span> | 4-10-2014</h5>

    <p>Setting up multiple types of authentication on an application can be a daunting task. There are a ton of moving pieces and you want to make sure that your user model is up to the task of consuming any type of authentication you throw at it. To that end, I recently set up Facebook authentication on a Sails.js app I&#39;m working on and I thought it might be worth sharing how easy it actually turned out to be.</p>
<!-- more -->

<h3>Passport To The Rescue!</h3>
<p>The good news is that if you are creating a Sails app, you can use <a href="https://github.com/jaredhanson/passport">Passport</a>, which makes using multiple types of validation a ton easier.</p>
<p>Passport authenticates requests through plugins known as &quot;strategies&quot;. Almost any of the strategies you can imagine, such as Facebook, Twitter, Github, Username/Password, etc... are already written. It&#39;s also really easy to write your own strategy if needed. Each strategy just takes a little bit of configuration and then gives you a callback when the login succeeds or fails.</p>
<p>Ok, enough talk. Let&#39;s get started, shall we?</p>
<h3>Install Passport</h3>
<p>You will need to install the passport npm module:</p>
<pre><code class="language-bash">npm install passport</code></pre>
<p>As well as the passport-facebook module:</p>
<pre><code class="language-bash">npm install passport-facebook</code></pre>
<p>We&#39;ll come back to this, but we need to create a model to hold the data for the user first.</p>
<h3>Create a User Model</h3>
<p>To do authentication, we will need a user model to check our login against. You can generate your model from the command line using:</p>
<pre><code class="language-bash">sails generate user</code></pre>
<p>That will spit out a model in <code>/api/models/User.js</code> as well as a controller in <code>/api/controllers/UserController.js</code>.</p>
<p>The User model should look something like this:</p>
<pre><code class="language-js">/**
 * User
 *
 * @module      :: Model
 * @description :: A short summary of how this model works and what it represents.
 * @docs        :: http://sailsjs.org/#!documentation/models
 */

module.exports = {

  attributes: {

    /* e.g.
    nickname: &#39;string&#39;
    */

  }

};</code></pre>
<p>Now, we just need to update the attributes that are being exported to include the facebookId:</p>
<pre><code class="language-js">module.exports = {

  attributes: {

    facebookId: {
      type: &#39;string&#39;,
      required: true,
      unique: true
    }

  }

};</code></pre>
<h3>Update the User Controller</h3>
<p>You will need to add a little logic to the user controller to handle authentication with Facebook. As I mentioned earlier, the user controller should be located at <code>/api/controllers/UserController.js</code>. Some of the routes and request scope may need to be changed based on your needs, but this is essentially how I got it working:</p>
<pre><code class="language-js">var passport = require(&#39;passport&#39;);

module.exports = {

  login: function (req, res) {
    res.view();
  },

  dashboard: function (req, res) {
    res.view();
  },

  logout: function (req, res){
    req.session.user = null;
    req.session.flash = &#39;You have logged out&#39;;
    res.redirect(&#39;user/login&#39;);
  },

  &#39;facebook&#39;: function (req, res, next) {
     passport.authenticate(&#39;facebook&#39;, { scope: [&#39;email&#39;, &#39;user_about_me&#39;]},
        function (err, user) {
            req.logIn(user, function (err) {
            if(err) {
                req.session.flash = &#39;There was an error&#39;;
                res.redirect(&#39;user/login&#39;);
            } else {
                req.session.user = user;
                res.redirect(&#39;/user/dashboard&#39;);
            }
        });
    })(req, res, next);
  },

  &#39;facebook/callback&#39;: function (req, res, next) {
     passport.authenticate(&#39;facebook&#39;,
        function (req, res) {
            res.redirect(&#39;/user/dashboard&#39;);
        })(req, res, next);
  }

};</code></pre>
<h3>Create the Passport Service</h3>
<p>This is probably the biggest addition you will need to make to get your app accepting Facebook logins. This should all go in <code>api/services/passport.js</code>.</p>
<p>Remember to replace the clientId and ClientSecret with your own Facebook app credentials. If you don&#39;t have them yet, you can create them at <a href="http://developers.facebook.com/">developers.facebook.com</a></p>
<pre><code class="language-js">var passport = require(&#39;passport&#39;),
  FacebookStrategy = require(&#39;passport-facebook&#39;).Strategy;

function findById(id, fn) {
  User.findOne(id).done(function (err, user) {
    if (err) {
      return fn(null, null);
    } else {
      return fn(null, user);
    }
  });
}

function findByFacebookId(id, fn) {
  User.findOne({
    facebookId: id
  }).done(function (err, user) {
    if (err) {
      return fn(null, null);
    } else {
      return fn(null, user);
    }
  });
}

passport.serializeUser(function (user, done) {
  done(null, user.id);
});

passport.deserializeUser(function (id, done) {
  findById(id, function (err, user) {
    done(err, user);
  });
});

passport.use(new FacebookStrategy({
    clientID: &quot;YOUR-FACEBOOK-CLIENT-ID&quot;,
    clientSecret: &quot;YOUR-FACEBOOK-CLIENT-SECRET&quot;,
    callbackURL: &quot;http://localhost:1337/user/facebook/callback&quot;,
    enableProof: false
  }, function (accessToken, refreshToken, profile, done) {

    findByFacebookId(profile.id, function (err, user) {

      // Create a new User if it doesn&#39;t exist yet
      if (!user) {
        User.create({

          facebookId: profile.id

          // You can also add any other data you are getting back from Facebook here 
          // as long as it is in your model

        }).done(function (err, user) {
          if (user) {
            return done(null, user, {
              message: &#39;Logged In Successfully&#39;
            });
          } else {
            return done(err, null, {
              message: &#39;There was an error logging you in with Facebook&#39;
            });
          }
        });

      // If there is already a user, return it
      } else {
        return done(null, user, {
          message: &#39;Logged In Successfully&#39;
        });
      }
    });
  }
));</code></pre>
<h3>Add the Express Middleware</h3>
<p>You will need to add a little bit of middleware in order to use Passport with Express. I just created a file called <code>/config/express.js</code> with this logic:</p>
<pre><code class="language-js">var passport = require(&#39;passport&#39;);

module.exports.express = {
    customMiddleware: function(app){

        // Passport
        app.use(passport.initialize());
        app.use(passport.session());

        app.use(function(req, res, next){
            res.locals.user = req.session.user;
            next();
        });

    }
};</code></pre>
<p>All it&#39;s really doing is initializing passport, using the passport session and adding the user to the local scope of any views that are being rendered.</p>
<h3>Create a Login View</h3>
<p>Create a view in <code>views/user/login.ejs</code> The bare bones of the login view should look like this:</p>
<pre><code class="language-html">&lt;a href=&quot;/user/facebook&quot;&gt;Login With Facebook&lt;/a&gt;</code></pre>
<p>Let&#39;s also throw up a dashboard view in <code>views/user/dashboard.ejs</code>:</p>
<pre><code class="language-html">&lt;p&gt;You are logged in! Your id is &lt;strong&gt;&lt;%- user.id %&gt;&lt;/strong&gt; and your Facebook Id is &lt;strong&gt;&lt;%- user.facebookId %&gt;&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;&lt;a href=&quot;/user/logout&quot;&gt;Logout&lt;/a&gt;&lt;/p&gt;</code></pre>
<p>Okay then. Now, you can test this whole thing by running <code>sails lift</code> in your command line and going to <a href="http://localhost:1337/user/login"><a href="http://localhost:1337/user/login">http://localhost:1337/user/login</a></a>. When you click on the &quot;Login With Facebook&quot; it should authenticate and then take you to the dashboard page. If you log out and try to go to the dashboard page again without logging back in, it will actually throw an error because there is no user in the session. Not the best experience, but it shows that the user has successfully logged out and it&#39;s fairly trivial to check for the user in the session and redirect if they don&#39;t exist.</p>
<p>So there you have it. Facebook authentication with Sails.js. Enjoy!</p>


    <br /><br />

    <div class="bio">
      <div class="span2">
        <img src="http://profile.ak.fbcdn.net/hprofile-ak-frc3/c0.0.828.828/s480x480/972098_667223423562_1734574442_n.jpg" class="lazy" />
      </div>
      <div class="span8">
        <h3><a href="/about">About the Author</a></h3>
        <p><strong>Tyson Cadenhead</strong> is a JavaScript engineer at <a href="http://appendto.com">appendTo</a>. He lives in the greater Nashville area. His specialty is writing large, scalable JavaScript applications on the client and server side. His passions are for good design, usability, and clean, reusable code.</p>
      </div>
    </div>

    <h5>Tags: 
    
        <span class="label">
            <a href="/?tag=sailsjs">sailsjs</a>
        </span>
    
        <span class="label">
            <a href="/?tag=facebook">facebook</a>
        </span>
    
        <span class="label">
            <a href="/?tag=authentication">authentication</a>
        </span>
    
    </h5>

</article>

<div class="share">
    <div class="addthis_toolbox addthis_default_style addthis_32x32_style">
        <a class="addthis_button_preferred_1"></a>
        <a class="addthis_button_preferred_2"></a>
        <a class="addthis_button_preferred_3"></a>
        <a class="addthis_button_preferred_4"></a>
        <a class="addthis_button_compact"></a>
        <a class="addthis_counter addthis_bubble_style"></a>
    </div>
</div>

<div class="google-things">

      <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-5130799763611680"
     data-ad-slot="1525472392"
     data-ad-format="auto"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>

  </div>

<div id="disqus_thread"></div>
<script type="text/javascript">
    var disqus_shortname = 'tysoncadenhead';

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
                    
                
            </div>
        </div>
        <script data-main="/js/app.js" src="/js/vendor/require.js"></script>
        <div class="footer">
                <div class="container">
                    <div class="addthis_default_style span12 addthis_32x32_style">
                        <a class="addthis_button_facebook_follow" addthis:userid="tysoncadenhead"></a>
                        <a class="addthis_button_twitter_follow" addthis:userid="tysoncadenhead"></a>
                        <a class="addthis_button_linkedin_follow" addthis:userid="tysoncadenhead"></a>
                        <a class="addthis_button_google_follow" addthis:userid="tysoncadenhead"></a>
                        <a class="addthis_button_youtube_follow" addthis:userid="tysoncadenhead"></a>
                        <a href="http://tysoncadenhead.deviantart.com/gallery/" title="Deviant Art" target="_blank" class="deviant-art"></a>
                        <a class="addthis_button_flickr_follow" addthis:userid="tysonlloydcadenhead"></a>
                        <a class="addthis_button_instagram_follow" addthis:userid="tysoncadenhead"></a>
                    </div>
                    <div class="span12" id="twitter-feed">
                        <a class="twitter-timeline" href="https://twitter.com/tysoncadenhead" data-widget-id="377141114454564864">Tweets by @tysoncadenhead</a>
                        <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+"://platform.twitter.com/widgets.js";fjs.parentNode.insertBefore(js,fjs);}}(document,"script","twitter-wjs");</script>
                        <script type="text/javascript">
                            window.tysonJS = {
                                slug: ''
                            };
                        </script>
                    </div>
                </div>
        </div>
    </body>
</html>