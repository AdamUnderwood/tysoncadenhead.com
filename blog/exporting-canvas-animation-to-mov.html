<!DOCTYPE html>
<!--[if IE 6]>
    <html id="ie6" lang="en-US">
<![endif]-->
<!--[if IE 7]>
    <html id="ie7" lang="en-US">
<![endif]-->
<!--[if IE 8]>
    <html id="ie8" lang="en-US">
<![endif]-->
<!--[if !(IE 6) | !(IE 7) | !(IE 8)  ]><!-->
    <html lang="en-US">
<!--<![endif]-->
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=400, initial-scale=0.5">
        <meta name="google-site-verification" content="AeV4w7EOhEv3lU1OT8KOM7jRS0C6jDAsZyMaG38t1g4" />
        <meta property="og:image" content="http://www.tysoncadenhead.com/images/blog/exporting-canvas-animation-to-mov.jpg"/>
        <meta property="og:title" content="Exporting Three JS Canvas Animations To MOV or MP4 Format With Socket.io"/>
        <meta property="og:url" content="http://www.tysoncadenhead.com"/>
        <meta property="og:site_name" content="Tyson Cadenhead"/>
        <meta property="og:description" content="Thoughts on productivity, web apps and JavaScript" />
        <title>Exporting Three JS Canvas Animations To MOV or MP4 Format With Socket.io</title>
        <link rel="shortcut icon" href="/images/favicon.ico" /> 
        <link rel="stylesheet" href="/css/app.css" />
        <link rel="alternate" type="application/rss+xml" title="Exporting Three JS Canvas Animations To MOV or MP4 Format With Socket.io Thoughts on productivity, web apps and JavaScript" href="http://www.tysoncadenhead.com/feed.xml" />
        
    </head>
    <body>
        <script type="text/javascript">

          var _gaq = _gaq || [];
          _gaq.push(['_setAccount', 'UA-19696495-1']);
          _gaq.push(['_trackPageview']);
        
          (function() {
            var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
            ga.src = ('https:' == document.location.protocol ? 'https://' : 'http://') + 'stats.g.doubleclick.net/dc.js';
            var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
          })();
        
        </script>
        <div id="fb-root"></div>
        <div class="header" id="top">
            <div class="container">
                <div class="span12">
                    <div class="span4 left">
                        <h1 id="logo"><a href="/"><img src="/images/logo.png" /></a></h1>
                    </div>
                    <div class="span6 right">
                        <div class="navbar navbar-inverse">
                            <div class="navbar-inner right">
                                <ul class="nav right">
                                  <li><a href="/">Blog</a></li>
                                  <li><a href="/presentations">Presentations</a></li>
                                  <li><a href="/about">About Me</a></li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="container">
            <div class="span12">
                
                    
                    
                        
                        <article>

    <div class="well span2 right thumbnail">
      <img src="/images/blog/exporting-canvas-animation-to-mov.jpg" />
    </div>

    <h1>Exporting Three JS Canvas Animations To MOV or MP4 Format With Socket.io</h1>

    

    <h5><span class="label label-info"><a href="/?category=code">code</a></span> | 3-17-2014</h5>

    <p>I have been a huge animation enthusiast since high-school. I even went to college hoping to become a professional computer animator before I got sucked into the wild world of computer programming. I have recently been dabbling with <a href="http://threejs.org/">Three JS</a>, which is a JavaScript engine for creating 3D models and animations for the browser.</p>
<p>Of course, my interests go beyond just making games and website animations. I like that the engine is written in JavaScript and that it uses web technologies like the canvas and WebGL to render the models. To that end, I have been exploring ways to export animations I make with Three JS to an external video file that I could use to stitch together actual films just like any application-based 3D animation software like Maya, Blender or Lightwave. I know it&#39;s crazy, but I think this might actually work.</p>
<!-- more -->

<p>So let&#39;s take the example that Three JS gives us for <a href="http://threejs.org/docs/index.html#Manual/Introduction/Creating_a_scene">creating our first scene</a>. The markup looks something like this:</p>
<pre><code class="language-js">&lt;html&gt;
    &lt;head&gt;
        &lt;title&gt;My first Three.js app&lt;/title&gt;
        &lt;style&gt;canvas { width: 100%; height: 100% }&lt;/style&gt;
    &lt;/head&gt;
    &lt;body&gt;
        &lt;script src=&quot;https://rawgithub.com/mrdoob/three.js/master/build/three.js&quot;&gt;&lt;/script&gt;
        &lt;script&gt;
            var scene = new THREE.Scene();
            var camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 1000);

            var renderer = new THREE.WebGLRenderer();
            renderer.setSize(window.innerWidth, window.innerHeight);
            document.body.appendChild(renderer.domElement);

            var geometry = new THREE.CubeGeometry(1,1,1);
            var material = new THREE.MeshBasicMaterial({color: 0x00ff00});
            var cube = new THREE.Mesh(geometry, material);
            scene.add(cube);

            camera.position.z = 5;

            var render = function () {
                requestAnimationFrame(render);

                cube.rotation.x += 0.1;
                cube.rotation.y += 0.1;

                renderer.render(scene, camera);

            };

            render();
        &lt;/script&gt;
    &lt;/body&gt;
&lt;/html&gt;</code></pre>
<p>Now, if we want to export something in the canvas, we can use the <code>toDataURL()</code> method on the canvas like this:</p>
<pre><code class="language-js">document.querySelector(&#39;canvas&#39;).toDataURL();</code></pre>
<p>If you run that command in your console, you will get a link to the current frame you are on. It should be noted that the toDataURL() method is not particularly fast. But when has rendering animations ever been fast?</p>
<p>So, if we want to capture all of the frames for a given length of animation, we should be able to use toDataURL() to output each of those URLs.</p>
<p>Three JS runs all of the rendering through the render function, so we can output our images there:</p>
<pre><code class="language-js">var render = function () {
    requestAnimationFrame(render);

    cube.rotation.x += 0.1;
    cube.rotation.y += 0.1;

    renderer.render(scene, camera);

    if (cube.rotation.x &lt; 3) {
        console.log(document.querySelector(&#39;canvas&#39;).toDataURL());
    }

};</code></pre>
<p>Notice that I put a conditional around the output to just give us the first 30 frames. We could do more, but the point is that you don&#39;t want to keep it spitting out frames forever if you want to keep your browser alive. If your animation isn&#39;t infinite like this example, it should be easier to figure out how many frames you need to export.</p>
<p>Okay, so now we are exporting frames, but let&#39;s be honest, that can get tedious really fast. What if we could send the frames over websockets and have our server automatically save the png files to our hard drive in order?</p>
<p>Our server should look something like this:</p>
<pre><code class="language-js">var app = require(&#39;express&#39;)(),
    server = require(&#39;http&#39;).createServer(app),
    io = require(&#39;socket.io&#39;).listen(server),
    fs = require(&#39;fs&#39;);

server.listen(3000);

app.get(&#39;/&#39;, function (req, res) {
    res.sendfile(__dirname + &#39;/index.html&#39;);
});

io.sockets.on(&#39;connection&#39;, function (socket) {
    socket.on(&#39;render-frame&#39;, function (data) {
        data.file = data.file.split(&#39;,&#39;)[1]; // Get rid of the data:image/png;base64 at the beginning of the file data
        var buffer = new Buffer(data.file, &#39;base64&#39;);
        fs.writeFile(__dirname + &#39;/tmp/frame-&#39; + data.frame + &#39;.png&#39;, buffer.toString(&#39;binary&#39;), &#39;binary&#39;);
    });
});</code></pre>
<p>As you can see, we have created a socket.io event called &quot;render-frame&quot; that takes an object with the file and the frame number and it creates an image in the <code>/tmp</code> directory with the frame number as part of the name and the meta-data from the file as the content of the image. We&#39;ll also need to update the client-side code to this:</p>
<pre><code class="language-js">&lt;html&gt;
    &lt;head&gt;
        &lt;title&gt;My first Three.js app&lt;/title&gt;
        &lt;style&gt;canvas { width: 100%; height: 100% }&lt;/style&gt;
    &lt;/head&gt;
    &lt;body&gt;
        &lt;script src=&quot;https://rawgithub.com/mrdoob/three.js/master/build/three.js&quot;&gt;&lt;/script&gt;
        &lt;script src=&quot;/socket.io/socket.io.js&quot;&gt;&lt;/script&gt;
        &lt;script&gt;
            var socket = io.connect(&#39;http://localhost:3000&#39;);
            var frame = 0;
            var scene = new THREE.Scene();
            var camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 1000);

            var renderer = new THREE.WebGLRenderer();
            renderer.setSize(window.innerWidth, window.innerHeight);
            document.body.appendChild(renderer.domElement);

            var geometry = new THREE.CubeGeometry(1,1,1);
            var material = new THREE.MeshBasicMaterial({color: 0x00ff00});
            var cube = new THREE.Mesh(geometry, material);
            scene.add(cube);

            camera.position.z = 5;

            var render = function () {
                requestAnimationFrame(render);

                cube.rotation.x += 0.1;
                cube.rotation.y += 0.1;

                renderer.render(scene, camera);

                if (cube.rotation.x &lt; 3) {
                    socket.emit(&#39;render-frame&#39;, {
                        frame: frame++,
                        file: document.querySelector(&#39;canvas&#39;).toDataURL()
                    });
                }

            };

            render();
        &lt;/script&gt;
    &lt;/body&gt;
&lt;/html&gt;</code></pre>
<p>Where we are basically just setting up the websocket and emitting the &quot;render-frame&quot; event instead of logging it and letting the server handle the heavy lifting.</p>
<p>At this point, we&#39;ve gotten as far as outputting the images, but there is still no video. However, if you have ffmpeg, you should be able to run:</p>
<pre><code class="language-bash">ffmpeg -r 60 -i /tmp/frame-%04d.png -vcodec libx264 -vpre lossless_slow -threads 0 output.mp4</code></pre>
<p>Which will output the video using the frames we&#39;ve outputted.</p>
<p>As you can see, even if there isn&#39;t an out of the box solution to export Three JS videos from the browser, it&#39;s really not that hard. It is totally possible to make animations with JavaScript that you could put on YouTube and premier at your next nearby film festival.</p>


    <h5>Tags: 
    
        <span class="label">
            <a href="/?tag=node">node</a>
        </span>
    
        <span class="label">
            <a href="/?tag=javascript">javascript</a>
        </span>
    
        <span class="label">
            <a href="/?tag=animation">animation</a>
        </span>
    
    </h5>

    <br />

    <div class="google-things">

        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <ins class="adsbygoogle"
       style="display:block"
       data-ad-client="ca-pub-5130799763611680"
       data-ad-slot="1525472392"
       data-ad-format="auto"></ins>
  <script>
  (adsbygoogle = window.adsbygoogle || []).push({});
  </script>

    </div>

    <br />

</article>

<div class="share">
    <div class="addthis_toolbox addthis_default_style addthis_32x32_style">
        <a class="addthis_button_preferred_1"></a>
        <a class="addthis_button_preferred_2"></a>
        <a class="addthis_button_preferred_3"></a>
        <a class="addthis_button_preferred_4"></a>
        <a class="addthis_button_compact"></a>
        <a class="addthis_counter addthis_bubble_style"></a>
    </div>
</div>

<div id="disqus_thread"></div>
<script type="text/javascript">
    var disqus_shortname = 'tysoncadenhead';

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
                    
                
            </div>
        </div>
        <script data-main="/js/app.js" src="/js/vendor/require.js"></script>
        <div class="footer">
                <div class="container">
                    <div class="addthis_default_style span12 addthis_32x32_style">
                        <a class="addthis_button_facebook_follow" addthis:userid="tysoncadenhead"></a>
                        <a class="addthis_button_twitter_follow" addthis:userid="tysoncadenhead"></a>
                        <a class="addthis_button_linkedin_follow" addthis:userid="tysoncadenhead"></a>
                        <a class="addthis_button_google_follow" addthis:userid="tysoncadenhead"></a>
                        <a class="addthis_button_youtube_follow" addthis:userid="tysoncadenhead"></a>
                        <a class="addthis_button_flickr_follow" addthis:userid="tysonlloydcadenhead"></a>
                        <a class="addthis_button_instagram_follow" addthis:userid="112101485541389007178"></a>
                    </div>
                    <div class="span12" id="twitter-feed">
                        <a class="twitter-timeline" href="https://twitter.com/tysoncadenhead" data-widget-id="377141114454564864">Tweets by @tysoncadenhead</a>
                        <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+"://platform.twitter.com/widgets.js";fjs.parentNode.insertBefore(js,fjs);}}(document,"script","twitter-wjs");</script>
                        <script type="text/javascript">
                            window.tysonJS = {
                                slug: ''
                            };
                        </script>
                    </div>
                </div>
        </div>
    </body>
</html>